# BlenderAddon-AutoMerge
## はじめに
このデータは、3Dモデリングソフト Blender 用のアドオンです。  

モデルのオブジェクト数が多い！  
モディファイアを適用してから結合（マージ）するのめんどくさい！  
というときに便利なアドオンです。  

---  
### 同作者の別アドオンとの連携
[ShapeKeys Util](https://sleetcatshop.booth.pm/items/1224307) との連携機能を有効にすることにより、シェイプキーをもつオブジェクトのモディファイアを適用してマージできるようになります。

---
### バージョンVer_2.2.0以前から移行する際の注意
1. エクスポート時のマージ対象かどうかの識別方法が変更されました。  
   - 2.2.0以前: `MergeGroup`という名前のコレクションに入っているオブジェクトをマージ対象とする
   - 2.2.0以降: `MergeGroup`という名前のpropが有効になっているオブジェクトをマージ対象とする

   別のblendファイルからオブジェクトを単体インポートするとコレクションの設定が初期化されてしまうため、これまではコレクションを再設定しなければなりませんでした。  
   オブジェクト自体のpropに各種フラグを持たせる仕様に変更したことにより、インポート後の再設定が不要になりました。

2. バージョンVer_2.2.0以前に本アドオンに搭載されていたfbxエクスポート機能は、別アドオン『MizoresCustomExporter』として分離しました。  
エクスポート時の自動マージ機能を使用する場合は、こちらのアドオンをインストールしてください。


## 機能説明
各種機能は`オブジェクトモードで右クリック → Auto Merge → 各機能名`で呼び出すことができます。

### Auto Merge → Merge Children
選択中オブジェクトの子階層以下にあるオブジェクトをマージします。

- 設定
  - **Duplicate**: チェックを入れると、対象となるオブジェクトを複製した上でマージ処理を行います。
  - **Apply Parent Object Modifiers**: チェックを入れると、結合先オブジェクトのモディファイアを適用します。

### Merge Grouped Children
選択中のオブジェクトのうち、オブジェクトグループ"MergeGroup"に属するものに対し、それぞれ子階層以下にあるオブジェクトをマージします。

（アドオン『MizoresExporter』によるAutoMerge連携機能はこのコマンドと同じ動作でマージ処理を行います）

- 設定
  - **Duplicate**: チェックを入れると、対象となるオブジェクトを複製した上でマージ処理を行います。
  - **Apply Parent Object Modifiers**: チェックを入れると、結合先オブジェクトのモディファイアを適用します。

### Merge Selection
最後に選択したオブジェクトに対し、選択中の他オブジェクトをマージします。

- 設定
  - **Duplicate**: チェックを入れると、対象となるオブジェクトを複製した上でマージ処理を行います。
  - **Apply Parent Object Modifiers**: チェックを入れると、結合先オブジェクトのモディファイアを適用します。

### Assign Merge Group
選択中のオブジェクトをコレクション"MergeGroup"に入れたり外したりします。

Export → Auto Mergeでのエクスポート時、"MergeGroup"に入っているオブジェクトは
子オブジェクトを結合した状態でエクスポートされます。

- 設定
  - **Assign**: チェックを入れるとグループに追加、外すとグループから除外します。

### 子オブジェクト名の接頭辞
このアドオンで結合するオブジェクトの子オブジェクト名の先頭に以下の文字列を付けることにより、特殊な結合処理を行うことができます。
- `%SHAPE%` Join as shape親オブジェクトに結合（親オブジェクトと頂点数が一致している必要があります）  

### モディファイア名の接頭辞
このアドオンで結合されるオブジェクトに設定されているモディファイアの名前の先頭に以下の文字列を付けることにより、特殊な結合処理を行うことができます。
- `%A%` Armatureなどの通常は適用されないモディファイアを強制的に適用
- `%KEEP%` モディファイアを適用せずに処理を続行
- `%AS%` 形状をシェイプキーとして適用（変化後の

### Variants Merge
執筆中

## 注意

- マージする際、Armatureを除く全てのモディファイアは適用されます。ただし、レンダリング対象でないモディファイア（モディファイア一覧でカメラアイコンが押されていないもの）は適用せず無視されます。

- 同作者の別アドオン"ShapeKeys Util"との連携機能が無効になっている場合、シェイプキーをもつオブジェクトはモディファイアを無視してマージ処理を行います。その場合でも、シェイプキーを含まない他のオブジェクトは通常通りにモディファイア適用・マージを行います。

## 動作例
以下の動作は同梱の『Sample.blend』ファイルで実際に確認できます。  
  

例えば、以下のような階層構造・オブジェクトグループ設定のデータがあったとします。  
（オブジェクトの順序は前後する場合あり）

・Sample.blend  
├Armature　　　　　グループ設定：無  
│├Body　　　　　　グループ設定：MergeGroup  
││├Clothes　　　 グループ設定：無  
│││└Ribbon　　　グループ設定：無  
││└Head　　　　　グループ設定：無  
│├Hair　　　　　　グループ設定：MergeGroup  
││├BackHair　　　グループ設定：無   
││└FrontHair　　 グループ設定：無  
│├Plane　　　　　 グループ設定：DontExport  
│└Skirt　　　　　 グループ設定：無  
└Cube　　　　　　　グループ設定：DontExport  
└Plane.001　　　 グループ設定：無  
  
この状態で File → Export → Auto Merge(.fbx) を使用し、出力されたfbxファイルをUnityにインポートすると以下のような階層構造のデータになっているのが確認できます。  
（オブジェクトの順序は前後する場合あり）  
  
・Sample  
├Armature  
│└（ボーン用オブジェクト）  
├Hair  
├Body  
└Skirt  

――――――
## 不具合・エラーが起きた時
このアドオンの機能はBlender標準のAPIを使って作成しているため、何らかの不具合が発生した場合にはすぐに Undo（Ctrl+Z） すれば機能使用前の状態に復元できます。  
アドオンの機能を使用する直前に保存していた場合はデータを読み込み直すのがより確実です。

また、以下の連絡先に不具合発生時の状況を送っていただけると修正の手助けになります。

## 連絡先
不具合報告や要望、感想などありましたらこちらにどうぞ。

修正・実装が可能と思われるものに関しては着手を検討しますが、多忙や技術的問題などの理由により対応できない場合があります。  
予めご了承ください。

Twitter：猫柳みぞれ　https://twitter.com/sleetcat123
